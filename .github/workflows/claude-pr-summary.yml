name: Claude PR Summary (Reusable)

on:
  workflow_call:
    inputs:
      pr_number:
        description: 'Pull request number'
        required: true
        type: string
      repository:
        description: 'Repository name (owner/repo)'
        required: true
        type: string
    secrets:
      claude_code_oauth_token:
        description: 'Claude Code OAuth token'
        required: true

jobs:
  summary:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Generate PR Summary
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.claude_code_oauth_token }}
          track_progress: false
          use_sticky_comment: false
          claude_args: '--model haiku --allowed-tools "Bash(gh pr view:*),Bash(gh pr diff:*),Bash(gh pr edit:*)"'
          prompt: |
            REPO: ${{ inputs.repository }}
            PR NUMBER: ${{ inputs.pr_number }}

            **YOUR TASK:**

            Generate a concise, technical summary of this pull request.

            Use CLAUDE.md if it exists to understand the repository context and what areas to highlight.

            **STEP 1: Gather PR Information**

            Get PR metadata:
            ```bash
            gh pr view ${{ inputs.pr_number }} --json title,body,files,additions,deletions
            ```

            Examine code changes:
            ```bash
            gh pr diff ${{ inputs.pr_number }}
            ```

            **STEP 2: Analyze Changes**

            Assess the following:
            - What functionality is being added/modified/removed?
            - How many files and lines changed?
            - Are there any breaking changes?
            - Code quality (type safety, patterns, best practices)
            - Complexity level:
              * Simple: <100 lines, single component/feature
              * Medium: 100-300 lines, multiple files, moderate scope
              * Complex: >300 lines, architectural changes, cross-cutting concerns

            **STEP 3: Generate Summary**

            Create a summary following this structure (max 150 words total):

            ```
            ## ðŸ“‹ PR Summary

            **Generated:** [timestamp]

            ### Overview
            [2-3 sentences: what does this PR do and why?]

            ### Key Changes
            - [Main change 1]
            - [Main change 2]
            - [Main change 3 if applicable]

            ### Impact Assessment
            - **Files Changed**: [number]
            - **Lines**: +[additions] -[deletions]
            - **Areas**: [list main areas/modules affected based on CLAUDE.md context if available]
            - **Breaking Changes**: [Yes/No - if yes, explain briefly]

            ### Technical Assessment
            - **Complexity**: [Simple/Medium/Complex - 1 line reason]
            - **Code Quality**: [Assessment based on codebase standards]
            - **Risk Level**: [Low/Medium/High - 1 line reason]

            ---

            *For detailed code review, comment `/review` on this PR*
            ```

            **STEP 4: Update PR Description**

            **CRITICAL: DO NOT use temp files or /tmp directory - GitHub Actions runners don't have write access!**

            Construct the body inline and pass directly to gh pr edit:

            ```bash
            # Get current body (use empty string if null)
            CURRENT_BODY=$(gh pr view ${{ inputs.pr_number }} --json body --jq '.body // ""')

            # Remove old summary if exists
            if echo "$CURRENT_BODY" | grep -q "<!-- CLAUDE_SUMMARY_START -->"; then
              CLEAN_BODY=$(echo "$CURRENT_BODY" | perl -0777 -pe 's/\n*---\n*<!-- CLAUDE_SUMMARY_START -->.*?<!-- CLAUDE_SUMMARY_END -->//gs')
            else
              CLEAN_BODY="$CURRENT_BODY"
            fi

            # Construct the new summary (replace placeholders with actual content)
            SUMMARY="## ðŸ“‹ PR Summary

            **Generated:** $(date +%Y-%m-%d)

            ### Overview
            [Your 2-3 sentence overview here]

            ### Key Changes
            - [Main change 1]
            - [Main change 2]

            ### Impact Assessment
            - **Files Changed**: [number]
            - **Lines**: +[additions] -[deletions]
            - **Areas**: [areas based on CLAUDE.md if available]
            - **Breaking Changes**: [Yes/No]

            ### Technical Assessment
            - **Complexity**: [Simple/Medium/Complex - brief reason]
            - **Code Quality**: [Assessment]
            - **Risk Level**: [Low/Medium/High - brief reason]

            ---

            *For detailed code review, comment \`/review\` on this PR*"

            # Combine clean body with new summary and update PR directly (NO temp files!)
            gh pr edit ${{ inputs.pr_number }} --body "${CLEAN_BODY}

            ---

            <!-- CLAUDE_SUMMARY_START -->
            ${SUMMARY}
            <!-- CLAUDE_SUMMARY_END -->"
            ```

            **IMPORTANT GUIDELINES:**

            - **NEVER use /tmp or any temp files** - GitHub Actions runners may not have write access
            - **NEVER use --body-file** - Always use --body with inline content
            - Keep it concise: max 150 words for the entire summary
            - Focus on WHAT changed and WHY, not code review feedback
            - Use context from CLAUDE.md if available
            - Highlight breaking changes prominently
            - Use technical language appropriate for developers
            - No code suggestions - this is informational only
            - Escape backticks in the summary with backslashes when constructing the body
